<!doctype html>
<html lang="en">
<head>
  <meta charset=UTF-8>
  <title>Celery Example</title>
</head>
<body>
<h1>Celery Example</h1>
<p>Execute background tasks with Celery. Submits tasks and shows results using JavaScript.</p>
<h2>Multiply</h2>
<p>Start a task to multiply two numbers, then poll for the result.</p>
<form id=mul method=post action="{{ url_for("tasks.mul") }}">
  <label>A <input type=number name=a value=4></label><br>
  <label>B <input type=number name=b value=2></label><br>
  <input type=submit>
</form>
<p>Result: <span id=mul-result></span></p>
<h2>All</h2>
<p>Start a task to add two numbers and have the resulted squared, then poll for the result.</p>
<form id=all method=post action="{{ url_for("tasks.all") }}">
  <label>A <input type=number name=a value=4></label><br>
  <label>B <input type=number name=b value=2></label><br>
  <input type=submit>
</form>
<p>Result: <span id=all-result></span></p>
<script>
  const taskForm = (formName, doPoll, report) => {
    document.forms[formName].addEventListener("submit", (event) => {
      event.preventDefault()
      fetch(event.target.action, {
        method: "POST",
        body: new FormData(event.target)
      })
        .then(response => response.json())
        .then(data => {
            console.log(data);

            const evtSource = new EventSource(`/tasks/sse/${data.result_id}`);

            evtSource.onerror = (err) => {
              console.debug("Closing Server Sent Events connection!", err)
              
              // We might close the connection here on the bases that the connection ended because no more data will be send.
              evtSource.close();
            }
          
            evtSource.onmessage = (event) => {
              console.debug(event);
              message = JSON.parse(event.data);
              if (message.state === "SUCCESS") {
                console.debug (`Result: ${message.result}`);
                
                // We must close the connection here!
                evtSource.close();
              }
              else {
                console.debug(`State: ${message.state}`);
              }
            };
        })
    })
  }

  taskForm("mul", true, data => {
    const el = document.getElementById("mul-result")

    if (data === null) {
      el.innerText = "submitted"
    } else if (!data["ready"]) {
      el.innerText = "waiting"
    } else if (!data["successful"]) {
      el.innerText = "error, check console"
    } else {
      el.innerText = data["value"]
    }
  })

  taskForm("all", true, data => {
    const el = document.getElementById("all-result")

    if (data === null) {
      el.innerText = "submitted"
    } else if (!data["ready"]) {
      el.innerText = "waiting"
    } else if (!data["successful"]) {
      el.innerText = "error, check console"
    } else {
      el.innerText = data["value"]
    }
  })

</script>
</body>
</html>