services:
  # On 20 March 2024, Redis moved away from the BSD license.
  # The last Redis release under the BSD license was version 7.2.4.
  #
  # In the future, we might want to move to https://valkey.io/
  redis:
    image: redis:7.2.4-alpine3.19

  rabbitmq:
    image: rabbitmq:3.13-alpine
    environment:
      RABBITMQ_DEFAULT_USER: celery
      RABBITMQ_DEFAULT_PASS: 123

  worker:
    depends_on:
      - redis
      - rabbitmq
    build:
      context: .
      target: pixi
    volumes:
      - type: bind
        source: .
        target: /usr/app
      - pixi-worker-cache:/usr/app/.pixi
    environment:
      RABBITMQ_DEFAULT_USER: celery
      RABBITMQ_DEFAULT_PASS: 123
    command: >
      bash -c "pixi install && pixi run start_worker"

  flower:
    depends_on:
      - redis
      - rabbitmq
      - worker
    build:
      context: .
      target: pixi
    expose:
      - 5555
    ports:
      - 5555:5555
    volumes:
      - type: bind
        source: .
        target: /usr/app
      - pixi-worker-cache:/usr/app/.pixi
    environment:
      RABBITMQ_DEFAULT_USER: celery
      RABBITMQ_DEFAULT_PASS: 123
    command: >
      bash -c "pixi install && pixi run start_flower"

  web:
    depends_on:
      - worker
    build:
      context: .
      target: pixi
    expose:
      - 5000
    ports:
      - 5000:5000
    volumes:
      - type: bind
        source: .
        target: /usr/app
      - pixi-web-cache:/usr/app/.pixi
    environment:
      RABBITMQ_DEFAULT_USER: celery
      RABBITMQ_DEFAULT_PASS: 123
    command: >
      bash -c "pixi install && pixi run start_web"
    

volumes:
  pixi-worker-cache:
  pixi-flower-cache:
  pixi-web-cache: